<?xml version="1.0" encoding="windows-1252"?>
  <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
    <Product
      Id="*"
      UpgradeCode="<%= settings[:upgrade_code] %>"
      Name="<%= settings[:product_name] %>"
      Language="1033"
      Codepage="1252"
      Version="<%= @version.sub(/\.g[0-9a-z]{7}/, '') %>"
      Manufacturer="<%= settings[:company_name] %>"
    />
    <Package
      InstallerVersion="300"
      InstallScope="perMachine"
      Description="<%= "#{settings[:product_word]}#{@platform.architecture == "x64" ? " (64-bit)" : ""}" %> Installer"
      Comments="<%= @homepage %>"
      Compressed="yes"
      Platform="<%= @platform.architecture %>"
    />
    <MajorUpgrade AllowDowngrades="yes" />
    <UI>
      <UIRef Id="WixUI_PuppetInstallDir"/>
      <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
      <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="<%= settings[:UI_exitdialogtext] %>" />
    </UI>
    <Media Id="1" Cabinet="<%= settings[:product_word] %>.cab" EmbedCab="yes" CompressionLevel="high" />

    <Feature Id="<%= settings[:product_word] %>Runtime" Title="<%= settings[:product_word] %> Runtime" Level="1">
      <ComponentRef Id="ProductComponentGroup" />
    </Feature>

    <!-- what about when install_root isn't the same number of directories deep? -->
    <Directory Id='TARGETDIR' Name='SourceDir'>
      <Directory Id="<%= settings[:base_directory] %>" >
        <Directory Id='INSTALLDIR' Name="<%= File.basename(settings[:install_root]) %>" />
      </Directory>
    </Directory>

    <WixVariable Id="WixUILicenseRtf" Value="wix\LICENSE.rtf" Overridable="yes" />
    <WixVariable Id="WixUIBannerBmp" Value="wix\ui\bitmaps\bannrbmp.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="wix\ui\bitmaps\dlgbmp-foss.bmp" />
    <WixVariable Id="WixUIExclamationIco" Value="wix\ui\bitmaps\exclamic.ico" />
    <WixVariable Id="WixUIInfoIco" Value="wix\ui\bitmaps\info.ico" />
    <WixVariable Id="WixUINewIco" Value="wix\ui\bitmaps\new.ico" />
    <WixVariable Id="WixUIUpIco" Value="wix\ui\bitmaps\up.ico" />

    <Icon Id="<%= settings[:company_word] %>.ico" SourceFile="wix\<%= settings[:company_word] %>.ico"/>
    <Property Id="ARPPRODUCTICON" Value="<%= settings[:company_word] %>.ico" />
    <Property Id="VersionUIString" Value="<%= @version %>" />
    <Property Id="ARPHELPLINK" Value="<%= settings[:links][:HelpLink] %>" />

    <SetProperty Id="ARPINSTALLLOCATION" Value="[INSTALLDIR]" After="CostFinalize" />
    <Property Id="INSTALLDIR">
      <RegistrySearch Id="RecallInstallDir" Root="HKLM" Key="SOFTWARE\<%= settings[:company_name] %>\<%= settings[:product_word] %>" Name="<%= settings[:RememberedInstallDirRegKey] %>" Type="raw" Win64="<%= settings[:win64] %>" />
    </Property>
    <Property Id="INSTALLDIR_X86" >
      <RegistrySearch Id="RecallInstallDirx86" Root="HKLM" Key="SOFTWARE\<%= settings[:company_name] %>\<%= settings[:product_word] %>" Name="<%= settings[:RememberedInstallDirRegKey] %>" Type="raw" Win64="<%= settings[:win64] %>" />
    </Property>

    <Component Id="RegistryEntriesArchitectureDependent" Guid="E6D5AF4F-ACC4-4D11-AFCE-299A9ED2152C" Win64="<%= settings[:win64] %>" Permanent="yes">
      <RegistryKey Root="HKLM" Key="SOFTWARE\<%= settings[:company_name] %>\<%= settings[:product_name] %>" Action="create" >
        <RegistryValue Type="integer" Value="0"/>
        <RegistryValue Name="RememberedInstallDir" Type="string" Value="<%= @platform.architecture == "x64" ? "[INSTALLDIR_X86]" : "[INSTALLDIR]" %>"  KeyPath="yes" />
        <%- if @platform.architecture == "x64" -%>
        <RegistryValue Name="RememberedInstallDir64" Type="string" Value="[INSTALLDIR]" KeyPath="yes" />
        <%- end -%>
      </RegistryKey>
    </Component>

  <!-- INSTALLDIR -->
  <CustomAction Id="SaveCmdLineInstallDir" Property="CMDLINE_INSTALLDIR" Value="[INSTALLDIR]" Execute="firstSequence" />
  <CustomAction Id="SetFromCmdLineInstallDir" Property="INSTALLDIR" Value="[CMDLINE_INSTALLDIR]" Execute="firstSequence" />

  <%- if @platform.architecture == "x86" -%>
    <CustomAction Id="Remove64BitPath_SetProp" Property="Remove64BitPath" Value="&quot;[%WINDIR]\System32\WindowsPowerShell\v1.0\powershell.exe&quot; -NoLogo -NonInteractive -InputFormat None -NoProfile -ExecutionPolicy Bypass -Command &quot;[\[]System.Text.RegularExpressions.Regex[\]]::Replace([\[]Microsoft.Win32.Registry[\]]::LocalMachine.OpenSubKey(&apos;SYSTEM\CurrentControlSet\Control\Session Manager\Environment\&apos;).GetValue(&apos;PATH&apos;, &apos;&apos;, [\[]Microsoft.Win32.RegistryValueOptions[\]]::DoNotExpandEnvironmentNames).ToString(),  [\[]System.Text.RegularExpressions.Regex[\]]::Escape(&apos;[ProgramFiles64Folder]$(var.OurCompanyName)\Puppet\bin&apos;) + &apos;([\?]&gt;;)[\?]&apos;, &apos;&apos;, [\[]System.Text.RegularExpressions.RegexOptions[\]]::IgnoreCase) | %[\{][\[]System.Environment[\]]::SetEnvironmentVariable(&apos;PATH&apos;,$_, &apos;Machine&apos;)[\}]&quot;" Execute="immediate" />
    <CustomAction Id="Remove64BitPath" BinaryKey="WixCA" DllEntry="CAQuietExec64" Execute="deferred" Return="ignore" />
    <CustomAction Id="Remove64BitProgramFiles_SetProp" Property="Remove64BitProgramFiles" Value="&quot;[%WINDIR]\System32\cmd.exe&quot; /c IF EXIST &quot;[ProgramFiles64Folder]$(var.OurCompanyName)\&quot; rmdir /s /q &quot;[ProgramFiles64Folder]$(var.OurCompanyName)&quot;" Execute="immediate" />
    <CustomAction Id="Remove64BitProgramFiles" BinaryKey="WixCA" DllEntry="CAQuietExec64" Execute="deferred" Return="ignore" />
  <%- end -%>

  <InstallUISequence>
    <!-- INSTALLDIR -->
    <Custom Action='SaveCmdLineInstallDir' Before='AppSearch' />
    <Custom Action='SetFromCmdLineInstallDir' After='AppSearch'>CMDLINE_INSTALLDIR</Custom>
  </InstallUISequence>
  <InstallExecuteSequence>
    <!-- INSTALLDIR -->
    <Custom Action='SaveCmdLineInstallDir' Before='AppSearch' />
    <Custom Action='SetFromCmdLineInstallDir' After='AppSearch'>CMDLINE_INSTALLDIR</Custom>
    <%- if @platform.architecture == "x86" -%>
      <Custom Action='Remove64BitPath_SetProp' After='CostFinalize' />
      <Custom Action='Remove64BitProgramFiles_SetProp' After='CostFinalize' />
      <Custom Action='Remove64BitProgramFiles' After='InstallFiles'><![CDATA[VersionNT64 >= 100 AND <%= settings[:win64] %> = no AND NOT (&<%= settings[:product_word] %>Runtime = 2)]]></Custom>
      <Custom Action='Remove64BitPath' After='InstallFiles'><![CDATA[VersionNT64 >= 100 AND <%= settings[:win64] %> = no AND NOT (&<%= settings[:product_word] %>Runtime = 2)]]></Custom>
    <%- end -%>
  </InstallExecuteSequence>
  </Product>
</Wix>
